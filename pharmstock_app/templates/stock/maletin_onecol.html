{% extends "stock/base.html" %}
{% block title %}Malet√≠n ¬∑ {{ col_label }}{% endblock %}

{% block content %}
<h2 class="mb-3">Malet√≠n ¬∑ Editar: {{ col_label }}</h2>

{% include "stock/_maletin_toolbar.html" with view=col funcion=funcion funciones=funciones %}

<table class="table-compact">
  <thead>
    <tr>
      <th style="width:80px;">Funci√≥n</th>
      <th style="width:160px;">C√≥digo</th>
      <th>Descripci√≥n</th>
      <th style="width:160px;">{{ col_label }}</th>
      <th style="width:120px;">Acciones</th>
    </tr>
  </thead>
  <tbody id="rows">
    {% for row in rows %}
      {% include "stock/_maletin_onecol_row.html" with row=row col=col %}
    {% endfor %}
  </tbody>
</table>  {# ‚Üê‚Üê IMPORTANTE: cerrar la tabla #}

<div class="mt-2 d-flex gap-2">
  <button id="saveAllBtn" class="btn btn-primary">üíæ Guardar todo ({{ col_label }})</button>
  <button type="button" class="btn btn-cancel" onclick="location.reload()">‚Ü©Ô∏è Descartar</button>
</div>

<script>
  // Navegaci√≥n vertical r√°pida
  document.addEventListener('keydown', (e) => {
    const a = document.activeElement;
    if (!a || !a.matches('input[type="number"]')) return;
    if (['ArrowDown','ArrowUp','Enter'].includes(e.key)) {
      e.preventDefault();
      const name = a.getAttribute('name');
      const list = Array.from(document.querySelectorAll(`input[name="${name}"]`));
      const i = list.indexOf(a);
      const delta = e.key === 'ArrowUp' ? -1 : 1;
      const next = list[i + delta];
      if (next) { next.focus(); next.select(); }
    }
  });

  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  document.getElementById('saveAllBtn').addEventListener('click', async () => {
    const rows = Array.from(document.querySelectorAll('#rows tr[id^="row-"]'));
    const items = rows.map(tr => {
      const codigo = tr.getAttribute('data-code');
      const funcion = tr.getAttribute('data-funcion');
      const obj = { codigo, funcion };
      {% if col == 'cantidad_existente' %}
        obj.cantidad_existente = tr.querySelector('input[name="cantidad_existente"]').value;
      {% elif col == 'cantidad_ideal' %}
        obj.cantidad_ideal = tr.querySelector('input[name="cantidad_ideal"]').value;
      {% endif %}
      return obj;
    });

    const resp = await fetch("{% url 'maletin_save_all' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({ items })
    });
    const data = await resp.json();
    if (data.ok) {
      alert(`‚úî Guardado masivo OK. Cambios en cantidades: ${data.changed_qty||0}, ideales: ${data.changed_ideal||0}`);
    } else {
      alert('Error: ' + (data.error || 'desconocido'));
    }
  });
</script>
{% endblock %}
